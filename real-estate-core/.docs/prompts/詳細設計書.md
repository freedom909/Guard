あなたは企業向け業務システムの詳細設計を
厳密にコード化する実装生成エンジンである。

本入力は正式な詳細設計書であり、
明記されていない仕様・権限・処理を
推測・補完してはならない。

以下の詳細設計書に基づき、
RBAC × 状態遷移 × Kafka 連携を実装せよ。

【出力制限】
- RBAC 判定ロジック
- 状態遷移ステートマシン
- Kafka Event Publisher / Consumer のみ出力
- UI / API / DB 定義は禁止
- output must be javascript or typescript code


【品質要件】
- Production 利用前提
- 擬似コード禁止
- TODO 禁止
- 権限拒否・状態不整合時は明示的に例外を送出すること


X.X RBAC × 状態遷移 × イベント連携設計
1. 目的（Purpose）

本設計は、売買契約管理システムにおける
業務判断責任の所在明確化、
権限逸脱の技術的防止、
および イベント駆動（Kafka）連携時の統制確保 を目的として、
RBAC（Role-Based Access Control）と業務状態遷移、およびイベント処理を
不可分な統制単位として設計する ものである。

2. 設計方針（Design Principles）
No	方針
DP-01	業務状態の遷移は、必ず「判断主体」による業務判断を伴う
DP-02	判断主体と RBAC 権限は分離定義し、両方を満たさない限り実行不可
DP-03	RBAC は Allow 明示方式とし、未定義は Deny とする 
        RBAC 違反は
        業務例外ではなく セキュリティ例外 として扱う
        Consumer は処理を継続してはならない
DP-04	イベント処理（Kafka Consumer）においても RBAC を再検証する
        Kafka Consumer は Producer を一切信頼しない。
        Event に含まれる Actor 情報は認証結果ではなく、
        RBAC 再検証のための補助情報としてのみ利用する。
        Actor 情報欠落・RBAC 違反時は acknowledge を行わず、
        メッセージ処理は失敗として扱う。


DP-05	権限定義はコードではなく Policy として外部化する
3. 役割定義（Roles）
ロール	説明
Admin	システム管理者（業務判断権限なし）
Agent	業務担当者（本業務フローでは判断権限なし）
Owner	売主
Customer	買主
Pending_Agent	未承認業務担当者
4. 業務状態定義（Business States）
状態コード	状態名
S01	Applied
S02	ApplicationAccepted
S03	ContractConcluded
S04	PaymentCompleted
S05	TransactionCompleted
S0X	Refunded（返金）
5. 状態遷移定義（State Transitions）
Event	From	To	判断主体	成立根拠	ERP連携
ApplicationAccepted	S01	S02	Customer	受付要件充足	非連携
ContractConcluded	S02	S03	Owner / Customer	契約締結確認	販売管理参照
PaymentCompleted	S03	S04	Owner	入金確認承認	販売管理参照
TransactionCompleted	S04	S05	Owner / Customer	引渡完了確認	在庫管理参照

※ 本表に記載のない遷移は一切認めない。

6. RBAC 実行マトリクス（Role × Event）
Role \ Event	ApplicationAccepted	ContractConcluded	PaymentCompleted	TransactionCompleted
Admin	Deny	Deny	Deny	Deny
Agent	Deny	Deny	Deny	Deny
Owner	Deny	Allow	Allow	Allow
Customer	Allow	Allow	Deny	Allow
Pending_Agent	Deny	Deny	Deny	Deny
7. RBAC 実行ルール（Enforcement Rules）

RBAC 判定は イベント実行前 に必ず実施する

Allow が明示されていない場合は Deny とする

ワイルドカード（*）による暗黙許可は禁止

RBAC 判定ロジックは共通ガードとして実装する

8. 状態遷移実行フロー（RBAC 統合）
[Request]
   ↓
[判断主体チェック]
   ↓
[RBAC 権限チェック]
   ↓
[現在状態検証]
   ↓
[状態遷移]
   ↓
[イベント発行]

9. イベント連携設計（Kafka）
9.1 イベント構造
{
  "event": "ContractConcluded",
  "entityId": "TX-123",
  "actor": {
    "userId": "U-001",
    "role": "Owner"
  },
  "occurredAt": "2026-02-05T10:00:00Z"
}

9.2 Consumer 側制御

Consumer は 必ず RBAC 再検証を行う
Actor 情報は

API Gateway にて認証済みトークンから生成され

Kafka Event には 読み取り専用スナップショット として格納される

Consumer は Actor を信頼せず、RBAC による再検証のみを行う
Actor 情報が欠落しているイベントは即時 Reject

再検証失敗時は Dead Letter Queue に送信

10. 監査ログ設計（Audit Log）
項目	内容
Event	実行イベント
Role	実行ロール
判断根拠	ERP 確認結果等
判定結果	Allow / Deny
実行日時	ISO8601
11. 禁止事項（Explicit Prohibitions）

コード内での role 判定分岐

状態直接書換え

イベントの匿名発行

Consumer 側での権限推測

12. 設計結論

本設計により、
業務判断責任・権限・状態遷移・イベント連携が一貫して統制 され、
実装レベルでの逸脱を技術的に防止する。